<h1 id="solving-and-animating-the-15-puzzle-with-haskell-and-diagrams">Solving and Animating the 15-puzzle with Haskell and <em>diagrams</em></h1>
<p>We all have our favorite mini projects that we like to implement when trying a new programming language. One of mine is a solver for the 15-puzzle. In case your not familiar with the 15-puzzle it's a classic game with 4 rows and 4 columns containing 15 tiles labed 1-15 and one blank space. The object is to order the tiles from 1 to 15 by repeatedly choosing a tile to slide into the blank space. See the wikipedia article 15-puzzle.</p>
<p>One reason I like to code up a solver for the 15-puzzle is that the algorithm is a nice example of the interplay between algorithms and data structures. In particular, we use the A* algorithm which relies on a prioriy queue.</p>
<p>Recently, I realized that:</p>
<ul>
<li>the only programming language I use (when given a choice) is haskell,</li>
<li>for some reason I had never implemented a 15-puzzle solver in haskell,</li>
<li>it would be nice to animiate the solution using the <em>diagrams</em> EDSL,</li>
</ul>
<p>and hence this blog post was born. We start by getting the imports out of the way.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">module</span> <span style="">Main</span> <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Data</span><span style="">.</span><span style="">Array</span><span style="">.</span><span style="">Unboxed</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Data</span><span style="">.</span><span style="">List</span>                           <span style="color: red;">(</span><span style="">elemIndex</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Data</span><span style="">.</span><span style="">List</span><span style="">.</span><span style="">Split</span>                     <span style="color: red;">(</span><span style="">chunksOf</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Data</span><span style="">.</span><span style="">Maybe</span>                          <span style="color: red;">(</span><span style="">mapMaybe</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span> <span style="color: blue; font-weight: bold;">qualified</span> <span style="">Data</span><span style="">.</span><span style="">PQueue</span><span style="">.</span><span style="">Prio</span><span style="">.</span><span style="">Min</span>                <span style="color: blue; font-weight: bold;">as</span> <span style="">PQ</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Diagrams</span><span style="">.</span><span style="">Prelude</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">Diagrams</span><span style="">.</span><span style="">Backend</span><span style="">.</span><span style="">Rasterific</span><span style="">.</span><span style="">CmdLine</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span>           <span style="">System</span><span style="">.</span><span style="">Environment</span>
</code></pre>
<h2 id="creating-the-animated-gif">Creating the animated GIF</h2>
<p>Lets write the <em>diagrams</em> code to draw and animate a solution assuming we have already solved a puzzle. The solution takes the form <code>[Board]</code> where <code>Board</code> is an matrix of tiles. Each tile is a number between 1 and 15.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">type</span> <span style="">Board</span> <span style="color: red;">=</span> <span style="">UArray</span> <span style="color: red;">(</span><span style="">Int</span><span style="color: red;">,</span> <span style="">Int</span><span style="color: red;">)</span> <span style="">Int</span>
</code></pre>
<p>First we need to draw a single <code>Board</code>, i.e convert it to a diagram. Our strategy is to map a function that draws each tile onto the board, then concatenate the tile diagrams into a diagram of the puzzle board. <em>diagrams</em> has built in functions for vertically and horizontally concatenating lists of diagrams so we start by converting the <code>Board</code> to a list.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">fromBoard</span> <span style="color: red;">::</span> <span style="">Board</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">fromBoard</span> <span style="">b</span> <span style="color: red;">=</span> <span style="color: red;">[</span><span style="">row</span> <span style="">i</span> <span style="color: red;">|</span> <span style="">i</span> <span style="color: red;">&lt;-</span> <span style="color: red;">[</span><span class="hs-num">1</span><span style="color: red;">..</span><span style="">n</span><span style="color: red;">]</span><span style="color: red;">]</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">row</span> <span style="">i</span> <span style="color: red;">=</span> <span style="color: red;">[</span><span style="">b</span> <span style="">!</span> <span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span> <span style="color: red;">|</span> <span style="">j</span> <span style="color: red;">&lt;-</span> <span style="color: red;">[</span><span class="hs-num">1</span><span style="color: red;">..</span><span style="">n</span><span style="color: red;">]</span><span style="color: red;">]</span>
<span style="">&gt;</span>     <span style="">n</span> <span style="color: red;">=</span> <span style="">dim</span> <span style="">b</span>
</code></pre>
<p>The dimension of the game is the upper bound of the array since we are using 1 as the starting indices for our array.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">dim</span> <span style="color: red;">::</span> <span style="">Board</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">dim</span> <span style="color: red;">=</span> <span style="">snd</span> <span style="">.</span> <span style="">snd</span> <span style="">.</span> <span style="">bounds</span> 
</code></pre>
<p>Assuming we have a function <code>drawTile</code> that makes a number into a tile diagrams we can now create a diagram from a game board.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">boardDia</span> <span style="color: red;">::</span> <span style="">Board</span> <span style="color: red;">-&gt;</span> <span style="">Diagram</span> <span style="">B</span> <span style="">R2</span>
<span style="">&gt;</span> <span style="">boardDia</span> <span style="">b</span> <span style="color: red;">=</span> <span style="">bg</span> <span style="">gray</span>
<span style="">&gt;</span>            <span style="">.</span> <span style="">frame</span> <span class="hs-num">0.1</span>
<span style="">&gt;</span>            <span style="">.</span> <span style="">vcat'</span> <span style="color: red;">(</span><span style="">with</span> <span style="">&amp;</span> <span style="">sep</span> <span style="">.~</span> <span class="hs-num">0.075</span><span style="color: red;">)</span>
<span style="">&gt;</span>            <span style="">.</span> <span style="">map</span> <span style="color: red;">(</span><span style="">hcat'</span> <span style="color: red;">(</span><span style="">with</span> <span style="">&amp;</span> <span style="">sep</span> <span style="">.~</span> <span class="hs-num">0.075</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span>            <span style="">.</span> <span style="color: red;">(</span><span style="">map</span> <span style="">.</span> <span style="">map</span><span style="color: red;">)</span> <span style="">drawTile</span> <span style="">$</span> <span style="">fromBoard</span> <span style="">b</span> 
</code></pre>
<p>And here is <code>drawTile</code></p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">drawTile</span> <span style="color: red;">::</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Diagram</span> <span style="">B</span> <span style="">R2</span>
<span style="">&gt;</span> <span style="">drawTile</span> <span class="hs-num">0</span> <span style="color: red;">=</span> <span style="">square</span> <span class="hs-num">1</span> <span style="">#</span> <span style="">lw</span> <span style="">none</span>
<span style="">&gt;</span> <span style="">drawTile</span> <span style="">s</span> <span style="color: red;">=</span> <span style="">text</span> <span style="color: red;">(</span><span style="">show</span> <span style="">s</span><span style="color: red;">)</span> 
<span style="">&gt;</span>            <span style="">#</span> <span style="">fontSize</span> <span style="color: red;">(</span><span style="">Local</span> <span class="hs-num">1</span><span style="color: red;">)</span> 
<span style="">&gt;</span>            <span style="">#</span> <span style="">fc</span> <span style="">white</span>
<span style="">&gt;</span>            <span style="">#</span> <span style="">scale</span> <span class="hs-num">0.5</span>
<span style="">&gt;</span>            <span style="">#</span> <span style="">bold</span>
<span style="">&gt;</span>           <span style="">&lt;&gt;</span> <span style="">roundedRect</span> <span class="hs-num">1</span> <span class="hs-num">1</span> <span class="hs-num">0.2</span> 
<span style="">&gt;</span>            <span style="">#</span> <span style="">fc</span> <span style="">darkred</span>
</code></pre>
<p>Now we need to assemble a bunch of board diagrams into a GIF. All we need to do is pass a list of diagrams and delay times <code>[(Diagram B R2, Int)]</code> to the <code>mainWith</code> function, choose a .gif file extension when we run the program and <em>diagrams</em> will make an animated GIF.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">dias</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Board</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">Diagram</span> <span style="">B</span> <span style="">R2</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">dias</span> <span style="">bs</span> <span style="color: red;">=</span> <span style="">map</span> <span style="">boardDia</span> <span style="">bs</span> 
</code></pre>
<p>We show each board for 1 second and pause for three seconds before starting looping.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">times</span> <span style="color: red;">::</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">times</span> <span style="">n</span> <span style="color: red;">=</span> <span style="">replicate</span> <span style="color: red;">(</span><span style="">n</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span> <span class="hs-num">100</span> <span style="">++</span> <span style="color: red;">[</span><span class="hs-num">300</span><span style="color: red;">]</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">gifs</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Board</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="color: red;">(</span><span style="">Diagram</span> <span style="">B</span> <span style="">R2</span><span style="color: red;">,</span> <span style="">Int</span><span style="color: red;">)</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">gifs</span> <span style="">bs</span> <span style="color: red;">=</span> <span style="">zip</span> <span style="color: red;">(</span><span style="">dias</span> <span style="">bs</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">times</span> <span style="">.</span> <span style="">length</span> <span style="">$</span> <span style="">bs</span><span style="color: red;">)</span>
</code></pre>
<p>Here is an example main program that solves a puzzle read in from a text file. The format of the puzzle file has as first line a single integer representing the dimension of the puzzle and each additional line a string of integers representing a row of the starting puzzle board. Of course we still need to write, <code>solve</code>, <code>mkGameState</code>, and <code>boards</code>.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">main</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">do</span>
<span style="">&gt;</span>   <span style="">putStrLn</span> <span style="color: teal;">"Enter the name of the file containing the puzzle specification: "</span>
<span style="">&gt;</span>   <span style="">txt</span> <span style="color: red;">&lt;-</span> <span style="">readFile</span> <span style="">=&lt;&lt;</span> <span style="">getLine</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">let</span> <span style="">game</span> <span style="color: red;">=</span> <span style="">fromString</span> <span style="">txt</span>
<span style="">&gt;</span>       <span style="color: red;">(</span><span style="color: red;">[</span><span style="">n</span><span style="color: red;">]</span><span style="color: red;">,</span> <span style="">brd</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">game</span> <span style="color: blue; font-weight: bold;">of</span>
<span style="">&gt;</span>         <span style="">[]</span> <span style="color: red;">-&gt;</span> <span style="">error</span> <span style="color: teal;">"Invalid puzzle file"</span>
<span style="">&gt;</span>         <span style="">x</span><span style="">:</span><span style="">xs</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">x</span><span style="color: red;">,</span> <span style="">concat</span> <span style="">xs</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">let</span> <span style="">p</span> <span style="color: red;">=</span> <span style="">solve</span> <span style="">.</span> <span style="">mkGameState</span> <span style="">n</span> <span style="">$</span> <span style="">brd</span>
<span style="">&gt;</span>   <span style="">mainWith</span> <span style="">$</span> <span style="">gifs</span> <span style="color: red;">(</span><span style="">boards</span> <span style="">p</span><span style="color: red;">)</span> 
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">fromString</span> <span style="color: red;">::</span> <span style="">String</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">fromString</span> <span style="">s</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">map</span> <span style="">.</span> <span style="">map</span><span style="color: red;">)</span> <span style="">read</span> <span style="">ws</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> <span style="">ws</span> <span style="color: red;">=</span> <span style="">map</span> <span style="">words</span> <span style="color: red;">(</span><span style="">lines</span> <span style="">s</span><span style="color: red;">)</span>
</code></pre>
<h2 id="the-a-algorithm">The A* algorithm</h2>
<p>We are going to search for a solution using the A* algotihm. We will keep track of the state of the game in an algebraic data type called <code>GameState</code>.</p>
<p>The game state inludes the board, the number of moves up until this point and a previous state (unless this it the start state). We also cache the location of the blank tile and the manhattan distance to the goal state; so that we only need to calculate these things once.</p>
<p>Notice that <code>GameState</code> recursively contains the game state that preceeded it (wrapped in a <code>Maybe</code>) , except for the start state whose <code>previous</code> field will contain <code>Nothing</code>. This will allow us recreate all of the intermediate boards from the final solved board so that we can animate the game. We use the <code>boards</code> function to create the list containing each board from start to finish.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">GameState</span> <span style="color: red;">=</span> <span style="">GameState</span> 
<span style="">&gt;</span>   <span style="color: red;">{</span> <span style="">board</span>     <span style="color: red;">::</span> <span style="">Board</span>
<span style="">&gt;</span>   <span style="color: red;">,</span> <span style="">dist</span>      <span style="color: red;">::</span> <span style="">Int</span>
<span style="">&gt;</span>   <span style="color: red;">,</span> <span style="">blank</span>     <span style="color: red;">::</span> <span style="color: red;">(</span><span style="">Int</span><span style="color: red;">,</span> <span style="">Int</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="color: red;">,</span> <span style="">moves</span>     <span style="color: red;">::</span> <span style="">Int</span>
<span style="">&gt;</span>   <span style="color: red;">,</span> <span style="">previous</span>  <span style="color: red;">::</span> <span style="">Maybe</span> <span style="">GameState</span> 
<span style="">&gt;</span>   <span style="color: red;">}</span> <span style="color: blue; font-weight: bold;">deriving</span> <span style="color: red;">(</span><span style="">Show</span><span style="color: red;">,</span> <span style="">Eq</span><span style="color: red;">,</span> <span style="">Ord</span><span style="color: red;">)</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">boards</span> <span style="color: red;">::</span> <span style="">GameState</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">Board</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">boards</span> <span style="">p</span> <span style="color: red;">=</span> <span style="">reverse</span> <span style="">$</span> <span style="">brds</span> <span style="">p</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">brds</span> <span style="">q</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">previous</span> <span style="">q</span> <span style="color: blue; font-weight: bold;">of</span>
<span style="">&gt;</span>       <span style="">Nothing</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">board</span> <span style="">q</span><span style="color: red;">]</span>
<span style="">&gt;</span>       <span style="">Just</span> <span style="">r</span>  <span style="color: red;">-&gt;</span> <span style="">board</span> <span style="">q</span> <span style="">:</span> <span style="">brds</span> <span style="">r</span>
</code></pre>
<p>The possible moves.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">Direction</span> <span style="color: red;">=</span> <span style="">North</span> <span style="color: red;">|</span> <span style="">East</span> <span style="color: red;">|</span> <span style="">South</span> <span style="color: red;">|</span> <span style="">West</span>
</code></pre>
<p>We create a priority queue <code>Frontier</code> whose priorities are the sum of the moves made so far to reach the game state and the manhattan distance to the goal state. This is a consistent heuristic function which guarantees that the solution we find will take the minimum number of moves. The initial <code>Frontier</code> contains only the start state. Then we recusively pop the minimum game state from the queue and check to see if it is the goal, if it is we are done, if not we calculate the states reachable by a legal game move (<code>neighbors</code>) and add them to the queue. Here's the code.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">type</span> <span style="">Frontier</span> <span style="color: red;">=</span> <span style="">PQ</span><span style="">.</span><span style="">MinPQueue</span> <span style="">Int</span> <span style="">GameState</span>
</code></pre>
<p>Manhattan distance of a tile with value <code>v</code> at position <code>(i, j)</code>, for a game of dimension <code>n</code>.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">manhattan</span> <span style="color: red;">::</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>  <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">manhattan</span> <span style="">v</span> <span style="">n</span> <span style="">i</span> <span style="">j</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">v</span> <span style="">==</span> <span class="hs-num">0</span> <span style="color: blue; font-weight: bold;">then</span> <span class="hs-num">0</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">rowDist</span> <span style="">+</span> <span style="">colDist</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">rowDist</span> <span style="color: red;">=</span> <span style="">abs</span> <span style="color: red;">(</span><span style="">i</span><span style="color: green;">-</span><span class="hs-num">1</span> <span style="color: green;">-</span> <span style="color: red;">(</span><span style="color: red;">(</span><span style="">v</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span> <span style="">`div`</span> <span style="">n</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span>     <span style="">colDist</span> <span style="color: red;">=</span> <span style="">abs</span> <span style="color: red;">(</span><span style="">j</span><span style="color: green;">-</span><span class="hs-num">1</span> <span style="color: green;">-</span> <span style="color: red;">(</span><span style="color: red;">(</span><span style="">v</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span> <span style="">`mod`</span> <span style="">n</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>Manhattan distance of entire board.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">totalDist</span> <span style="color: red;">::</span> <span style="">Board</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">totalDist</span> <span style="">b</span> <span style="color: red;">=</span> <span style="">sum</span> <span style="color: red;">[</span><span style="">manhattan</span> <span style="color: red;">(</span><span style="">b</span> <span style="">!</span> <span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">n</span> <span style="">i</span> <span style="">j</span> <span style="color: red;">|</span> <span style="">i</span> <span style="color: red;">&lt;-</span> <span style="color: red;">[</span><span class="hs-num">1</span><span style="color: red;">..</span><span style="">n</span><span style="color: red;">]</span><span style="color: red;">,</span> <span style="">j</span> <span style="color: red;">&lt;-</span> <span style="color: red;">[</span><span class="hs-num">1</span><span style="color: red;">..</span><span style="">n</span><span style="color: red;">]</span><span style="color: red;">]</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> <span style="">n</span> <span style="color: red;">=</span> <span style="">dim</span> <span style="">b</span>
</code></pre>
<p>Create a start state from a list of tiles.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">mkGameState</span> <span style="color: red;">::</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="">GameState</span>
<span style="">&gt;</span> <span style="">mkGameState</span> <span style="">n</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="">GameState</span> <span style="">b</span> <span style="">d</span> <span style="">z</span> <span class="hs-num">0</span> <span style="">Nothing</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">b</span> <span style="color: red;">=</span> <span style="">listArray</span> <span style="color: red;">(</span><span style="color: red;">(</span><span class="hs-num">1</span><span style="color: red;">,</span> <span class="hs-num">1</span><span style="color: red;">)</span><span style="color: red;">,</span> <span style="color: red;">(</span><span style="">n</span><span style="color: red;">,</span> <span style="">n</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">xs</span>
<span style="">&gt;</span>     <span style="">d</span> <span style="color: red;">=</span> <span style="">totalDist</span> <span style="">b</span>
<span style="">&gt;</span>     <span style="">Just</span> <span style="">z'</span> <span style="color: red;">=</span> <span style="">elemIndex</span> <span class="hs-num">0</span> <span style="">xs</span>
<span style="">&gt;</span>     <span style="">z</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span class="hs-num">1</span> <span style="">+</span> <span style="">z'</span> <span style="">`div`</span> <span style="">n</span><span style="color: red;">,</span> <span class="hs-num">1</span> <span style="">+</span> <span style="">z'</span> <span style="">`mod`</span> <span style="">n</span><span style="color: red;">)</span>
</code></pre>
<p>Update the game state after switching the position of the blank and tile <code>(i, j)</code>.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">update</span> <span style="color: red;">::</span> <span style="">GameState</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">GameState</span>
<span style="">&gt;</span> <span style="">update</span> <span style="">p</span> <span style="">i</span> <span style="">j</span> <span style="color: red;">=</span> <span style="">p</span> <span style="color: red;">{</span> <span style="">board</span> <span style="color: red;">=</span> <span style="">b</span>
<span style="">&gt;</span>                  <span style="color: red;">,</span> <span style="">dist</span> <span style="color: red;">=</span> <span style="">totalDist</span> <span style="">b</span>
<span style="">&gt;</span>                  <span style="color: red;">,</span> <span style="">blank</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span>
<span style="">&gt;</span>                  <span style="color: red;">,</span> <span style="">moves</span> <span style="color: red;">=</span> <span style="">moves</span> <span style="">p</span> <span style="">+</span> <span class="hs-num">1</span>
<span style="">&gt;</span>                  <span style="color: red;">,</span> <span style="">previous</span> <span style="color: red;">=</span> <span style="">Just</span> <span style="">p</span> <span style="color: red;">}</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">b</span> <span style="color: red;">=</span> <span style="">b'</span> <span style="">//</span> <span style="color: red;">[</span><span style="color: red;">(</span><span style="">blank</span> <span style="">p</span><span style="color: red;">,</span> <span style="">b'</span> <span style="">!</span> <span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span><span style="color: red;">)</span><span style="color: red;">,</span> <span style="color: red;">(</span><span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span><span style="color: red;">,</span> <span class="hs-num">0</span><span style="color: red;">)</span><span style="color: red;">]</span>
<span style="">&gt;</span>     <span style="">b'</span> <span style="color: red;">=</span> <span style="">board</span> <span style="">p</span>
</code></pre>
<p>Find the the board that can be reached from the current state by moving in the specified direction, being careful not to move off the board.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">neighbor</span> <span style="color: red;">::</span> <span style="">GameState</span> <span style="color: red;">-&gt;</span> <span style="">Direction</span> <span style="color: red;">-&gt;</span> <span style="">Maybe</span> <span style="">GameState</span>
<span style="">&gt;</span> <span style="">neighbor</span> <span style="">p</span> <span style="">dir</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">dir</span> <span style="color: blue; font-weight: bold;">of</span>
<span style="">&gt;</span>   <span style="">North</span> <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">i</span> <span style="">&lt;=</span> <span class="hs-num">1</span>   <span style="color: blue; font-weight: bold;">then</span> <span style="">Nothing</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">Just</span> <span style="">$</span> <span style="">update</span> <span style="">p</span> <span style="color: red;">(</span><span style="">i</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span> <span style="">j</span>
<span style="">&gt;</span>   <span style="">East</span>  <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">j</span> <span style="">&gt;=</span> <span style="">n</span> <span style="color: blue; font-weight: bold;">then</span> <span style="">Nothing</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">Just</span> <span style="">$</span> <span style="">update</span> <span style="">p</span> <span style="">i</span> <span style="color: red;">(</span><span style="">j</span><span style="">+</span><span class="hs-num">1</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="">South</span> <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">i</span> <span style="">&gt;=</span> <span style="">n</span> <span style="color: blue; font-weight: bold;">then</span> <span style="">Nothing</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">Just</span> <span style="">$</span> <span style="">update</span> <span style="">p</span> <span style="color: red;">(</span><span style="">i</span><span style="">+</span><span class="hs-num">1</span><span style="color: red;">)</span> <span style="">j</span>
<span style="">&gt;</span>   <span style="">West</span>  <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">j</span> <span style="">&lt;=</span> <span class="hs-num">1</span>   <span style="color: blue; font-weight: bold;">then</span> <span style="">Nothing</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">Just</span> <span style="">$</span> <span style="">update</span> <span style="">p</span> <span style="">i</span> <span style="color: red;">(</span><span style="">j</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="color: red;">(</span><span style="">i</span><span style="color: red;">,</span> <span style="">j</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">blank</span> <span style="">p</span>
<span style="">&gt;</span>     <span style="">n</span> <span style="color: red;">=</span> <span style="">dim</span> <span style="">.</span> <span style="">board</span> <span style="">$</span> <span style="">p</span>
</code></pre>
<p>All of the states that can be reached in one move from the current state.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">neighbors</span> <span style="color: red;">::</span> <span style="">GameState</span> <span style="color: red;">-&gt;</span> <span style="color: red;">[</span><span style="">GameState</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">neighbors</span> <span style="">p</span> <span style="color: red;">=</span> <span style="">mapMaybe</span> <span style="color: red;">(</span><span style="">neighbor</span> <span style="">p</span><span style="color: red;">)</span> <span style="color: red;">[</span><span style="">North</span><span style="color: red;">,</span> <span style="">East</span><span style="color: red;">,</span> <span style="">South</span><span style="color: red;">,</span> <span style="">West</span><span style="color: red;">]</span>
</code></pre>
<p>Finally, solve the puzzle.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">solve</span> <span style="color: red;">::</span> <span style="">GameState</span> <span style="color: red;">-&gt;</span> <span style="">GameState</span>
<span style="">&gt;</span> <span style="">solve</span> <span style="">p</span> <span style="color: red;">=</span> <span style="">go</span> <span style="color: red;">(</span><span style="">PQ</span><span style="">.</span><span style="">fromList</span> <span style="color: red;">[</span><span style="color: red;">(</span><span style="">dist</span> <span style="">p</span><span style="color: red;">,</span> <span style="">p</span><span style="color: red;">)</span><span style="color: red;">]</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">go</span> <span style="">fr</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">dist</span> <span style="">puzzle</span> <span style="">==</span> <span class="hs-num">0</span> 
<span style="">&gt;</span>             <span style="color: blue; font-weight: bold;">then</span> <span style="">puzzle</span> 
<span style="">&gt;</span>             <span style="color: blue; font-weight: bold;">else</span> <span style="">go</span> <span style="">fr2</span>
<span style="">&gt;</span>       <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>         <span style="color: green;">-- Retrieve the game state with the lowest priority and remove it from</span>
<span style="">&gt;</span>         <span style="color: green;">-- the frontier.</span>
<span style="">&gt;</span>         <span style="color: red;">(</span><span style="color: red;">(</span><span style="color: blue; font-weight: bold;">_</span><span style="color: red;">,</span> <span style="">puzzle</span><span style="color: red;">)</span><span style="color: red;">,</span> <span style="">fr1</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">PQ</span><span style="">.</span><span style="">deleteFindMin</span> <span style="">fr</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span>         <span style="color: green;">-- If the new board is the smae as the previous board then</span>
<span style="">&gt;</span>         <span style="color: green;">-- do not add it to the queue since it has already been explored.</span>
<span style="">&gt;</span>         <span style="">ns</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">previous</span> <span style="">puzzle</span> <span style="color: blue; font-weight: bold;">of</span>
<span style="">&gt;</span>           <span style="">Nothing</span> <span style="color: red;">-&gt;</span> <span style="">neighbors</span> <span style="">puzzle</span>
<span style="">&gt;</span>           <span style="">Just</span> <span style="">n</span>  <span style="color: red;">-&gt;</span> <span style="">filter</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">x</span> <span style="color: red;">-&gt;</span> <span style="">board</span> <span style="">x</span> <span style="">/=</span> <span style="">board</span> <span style="">n</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">neighbors</span> <span style="">puzzle</span><span style="color: red;">)</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span>         <span style="color: green;">-- The priority of a puzzle is the number of moves so far</span>
<span style="">&gt;</span>         <span style="color: green;">-- plus the manhattan distance.</span>
<span style="">&gt;</span>         <span style="">ps</span>  <span style="color: red;">=</span> <span style="">zip</span> <span style="color: red;">[</span><span style="">moves</span> <span style="">q</span> <span style="">+</span> <span style="">dist</span> <span style="">q</span> <span style="color: red;">|</span> <span style="">q</span> <span style="color: red;">&lt;-</span> <span style="">ns</span><span style="color: red;">]</span> <span style="">ns</span>
<span style="">&gt;</span>         <span style="">fr2</span> <span style="color: red;">=</span> <span style="">foldr</span> <span style="color: red;">(</span><span style="">uncurry</span> <span style="">PQ</span><span style="">.</span><span style="">insert</span><span style="color: red;">)</span> <span style="">fr1</span> <span style="">ps</span>
</code></pre>
<div class="references">

</div>
